{% extends "base.html" %}

{% block title %}朋友圈 - 漂流瓶{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card user-info-card mb-4">
            <div class="card-body text-center">
                <h2><i class="fas fa-user"></i> 欢迎, {{ user_info.name }}!</h2>
                <p class="mb-0">
                    <i class="fas fa-phone"></i> 电话: {{ user_info.phone }} | 
                    <i class="fas fa-globe"></i> 国家: {{ user_info.place }} | 
                    <i class="fas fa-venus-mars"></i> 性别: {{ user_info.sex }}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 发布朋友圈 -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-edit"></i> 发布朋友圈</h5>
            </div>
            <div class="card-body">
                <form id="postMomentForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <textarea class="form-control" id="momentContent" name="content" rows="3" maxlength="200" placeholder="分享你的生活... (最多200字)"></textarea>
                        <div class="form-text text-end">还可以输入 <span id="charCount">200</span> 字符</div>
                    </div>
                    <div class="mb-3">
                        <label for="momentImage" class="form-label">图片 (最多1张)</label>
                        <input class="form-control" type="file" id="momentImage" name="image" accept="image/*">
                        <div class="form-text">支持 JPG, PNG, GIF 格式</div>
                        <div id="imagePreviewContainer" class="mt-2 d-none">
                            <div class="row" id="imagePreviewRow"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane"></i> 发布
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 朋友圈列表 -->
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-globe-asia"></i> 朋友圈</h5>
            </div>
            <div class="card-body p-0">
                <div id="momentsContainer">
                    <div class="text-center p-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 朋友圈详情模态框 -->
<div class="modal fade" id="momentDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-globe-asia"></i> 朋友圈详情</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="momentDetailContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 加载朋友圈
    loadMoments();
    
    // 设置定时刷新
    setInterval(loadMoments, 30000);
    
    // 字符计数
    $('#momentContent').on('input', function() {
        const maxLength = 200;
        const currentLength = $(this).val().length;
        const remaining = maxLength - currentLength;
        $('#charCount').text(remaining);
    });
    
    // 图片预览
    $('#momentImage').change(function() {
        const file = this.files[0];
        if (file) {
            $('#imagePreviewRow').empty();
            $('#imagePreviewContainer').removeClass('d-none');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = $(`<div class="col-12 mb-2"></div>`);
                const img = $(`<img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">`);
                col.append(img);
                $('#imagePreviewRow').append(col);
            }
            reader.readAsDataURL(file);
        } else {
            $('#imagePreviewContainer').addClass('d-none');
        }
    });
    
    // 发布朋友圈表单提交
    $('#postMomentForm').submit(function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        $.ajax({
            url: '/post_moment',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    alert('发布成功！');
                    $('#momentContent').val('');
                    $('#momentImage').val('');
                    $('#charCount').text('200');
                    $('#imagePreviewContainer').addClass('d-none');
                    $('#imagePreviewRow').empty();
                    loadMoments(); // 重新加载朋友圈
                } else {
                    alert('发布失败：' + response.message);
                }
            },
            error: function() {
                alert('发布失败，请稍后重试');
            }
        });
    });
});

// 加载朋友圈
function loadMoments() {
    $.get('/get_moments', function(response) {
        if (response.success) {
            displayMoments(response.data);
        } else {
            $('#momentsContainer').html(`<div class="alert alert-warning m-3">${response.message}</div>`);
        }
    }).fail(function() {
        $('#momentsContainer').html(`<div class="alert alert-danger m-3">加载朋友圈失败，请稍后重试</div>`);
    });
}

// 显示朋友圈
function displayMoments(moments) {
    let html = '';
    
    if (moments.length === 0) {
        html = `<div class="text-center p-5">
            <i class="fas fa-globe-asia fa-3x text-muted mb-3"></i>
            <p class="text-muted">暂无朋友圈内容，快来发布第一条吧！</p>
        </div>`;
    } else {
        moments.forEach(function(moment) {
            html += `
            <div class="border-bottom p-3">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <span class="text-white fw-bold">${moment.user_name.charAt(0).toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${moment.user_name}</h6>
                            <small class="text-muted">${moment.post_time}</small>
                        </div>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-phone"></i> ${moment.user_info.phone} | 
                            <i class="fas fa-globe"></i> ${moment.user_info.place} | 
                            <i class="fas fa-venus-mars"></i> ${moment.user_info.sex}
                        </p>
                        ${moment.content ? `<p class="mb-2">${moment.content}</p>` : ''}
                        
                        ${moment.image_paths ? `
                        <div class="row g-2 mb-2">
                            <div class="col-12">
                                <img src="/static/${moment.image_paths}" class="img-fluid rounded" style="max-height: 300px; object-fit: cover;" alt="朋友圈图片">
                            </div>
                        </div>` : ''}
                        
                        <div class="d-flex">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="likeMoment(${moment.id}, this)">
                                <i class="fas fa-thumbs-up ${moment.user_liked ? 'text-primary' : ''}"></i> 
                                <span id="likeCount_${moment.id}">${moment.like_count}</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="showMomentDetail(${moment.id})">
                                <i class="fas fa-comment"></i> 
                                <span>${moment.comments.length}</span>
                            </button>
                        </div>
                        
                        ${moment.comments.length > 0 ? `
                        <div class="mt-2 bg-light rounded p-2" id="commentsContainer_${moment.id}">
                            ${moment.comments.map(comment => `
                            <div class="mb-1">
                                <strong>${comment.user_name}:</strong> ${comment.comment}
                                <small class="text-muted float-end">${comment.comment_time}</small>
                            </div>
                            `).join('')}
                        </div>` : ''}
                        
                        <!-- 评论输入框 -->
                        <div class="mt-2">
                            <div class="input-group">
                                <input type="text" class="form-control comment-input" id="commentInput_${moment.id}" placeholder="添加评论..." maxlength="200">
                                <button class="btn btn-outline-primary comment-btn" type="button" onclick="addComment(${moment.id})">评论</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        });
    }
    
    $('#momentsContainer').html(html);
}


// 点赞朋友圈
function likeMoment(momentId, button) {
    $.post('/like_moment', {
        moment_id: momentId
    }, function(response) {
        if (response.success) {
            const likeCountElement = $('#likeCount_' + momentId);
            let currentCount = parseInt(likeCountElement.text());
            
            if (response.action === 'like') {
                $(button).find('i').addClass('text-primary');
                likeCountElement.text(currentCount + 1);
            } else {
                $(button).find('i').removeClass('text-primary');
                likeCountElement.text(currentCount - 1);
            }
        } else {
            alert('操作失败：' + response.message);
        }
    }).fail(function() {
        alert('操作失败，请稍后重试');
    });
}

// 添加评论
function addComment(momentId) {
    const commentInput = $('#commentInput_' + momentId);
    const comment = commentInput.val().trim();
    
    if (!comment) {
        alert('请输入评论内容');
        return;
    }
    
    if (comment.length > 200) {
        alert('评论内容不能超过200字');
        return;
    }
    
    $.post('/comment_moment', {
        moment_id: momentId,
        comment: comment
    }, function(response) {
        if (response.success) {
            // 清空输入框
            commentInput.val('');
            // 重新加载朋友圈
            loadMoments();
        } else {
            alert('评论失败：' + response.message);
        }
    }).fail(function() {
        alert('评论失败，请稍后重试');
    });
}

// 回车键发送评论
$(document).on('keypress', '.comment-input', function(e) {
    if (e.which == 13) {
        const momentId = $(this).attr('id').split('_')[1];
        addComment(momentId);
    }
});

// 显示朋友圈详情
function showMomentDetail(momentId) {
    // 获取特定朋友圈的详细信息
    $.get('/get_moments', function(response) {
        if (response.success) {
            // 找到对应的moment
            const moment = response.data.find(m => m.id == momentId);
            if (moment) {
                let html = `
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <span class="text-white fw-bold">${moment.user_name.charAt(0).toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="d-flex justify-content-between">
                            <h6 class="mb-1">${moment.user_name}</h6>
                            <small class="text-muted">${moment.post_time}</small>
                        </div>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-phone"></i> ${moment.user_info.phone} | 
                            <i class="fas fa-globe"></i> ${moment.user_info.place} | 
                            <i class="fas fa-venus-mars"></i> ${moment.user_info.sex}
                        </p>
                        ${moment.content ? `<p class="mb-3">${moment.content}</p>` : ''}
                        
                        ${moment.image_paths ? `
                        <div class="mb-3">
                            <img src="/static/${moment.image_paths}" class="img-fluid rounded" style="max-height: 400px; object-fit: cover;">
                        </div>` : ''}
                        
                        <div class="d-flex mb-3">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="likeMoment(${moment.id}, this)">
                                <i class="fas fa-thumbs-up ${moment.user_liked ? 'text-primary' : ''}"></i> 
                                <span id="detailLikeCount_${moment.id}">${moment.like_count}</span>
                            </button>
                        </div>
                        
                        <!-- 评论区域 -->
                        <div class="mt-3">
                            <h6>评论 (${moment.comments.length})</h6>
                            ${moment.comments.length > 0 ? `
                            <div class="mt-2 bg-light rounded p-2" id="detailCommentsContainer_${moment.id}">
                                ${moment.comments.map(comment => `
                                <div class="mb-2">
                                    <strong>${comment.user_name}:</strong> ${comment.comment}
                                    <small class="text-muted d-block">${comment.comment_time}</small>
                                </div>
                                `).join('')}
                            </div>` : '<p class="text-muted">暂无评论</p>'}
                            
                            <!-- 评论输入框 -->
                            <div class="mt-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="detailCommentInput_${moment.id}" placeholder="添加评论..." maxlength="200">
                                    <button class="btn btn-outline-primary" type="button" onclick="addDetailComment(${moment.id})">发送</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                
                $('#momentDetailContent').html(html);
                $('#momentDetailModal').modal('show');
            }
        } else {
            alert('获取朋友圈详情失败：' + response.message);
        }
    }).fail(function() {
        alert('获取朋友圈详情失败，请稍后重试');
    });
}

// 详情页添加评论
function addDetailComment(momentId) {
    const commentInput = $('#detailCommentInput_' + momentId);
    const comment = commentInput.val().trim();
    
    if (!comment) {
        alert('请输入评论内容');
        return;
    }
    
    if (comment.length > 200) {
        alert('评论内容不能超过200字');
        return;
    }
    
    $.post('/comment_moment', {
        moment_id: momentId,
        comment: comment
    }, function(response) {
        if (response.success) {
            // 清空输入框
            commentInput.val('');
            // 重新加载详情
            showMomentDetail(momentId);
        } else {
            alert('评论失败：' + response.message);
        }
    }).fail(function() {
        alert('评论失败，请稍后重试');
    });
}
</script>
{% endblock %}