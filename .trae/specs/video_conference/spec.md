# 实时视频会议功能 - 产品需求文档

## Overview
- **Summary**: 在现有聊天应用中增加实时视频会议功能，支持单聊和群组聊天场景下的视频会议预约、加入和管理。用户可以在聊天界面通过"+"按钮发起或加入视频会议，支持音视频通话、屏幕共享、聊天消息等核心功能。
- **Purpose**: 为用户提供便捷的实时视频沟通方式，增强聊天应用的互动性和实用性，满足远程协作和社交需求。
- **Target Users**: 已注册并使用聊天功能的用户，包括私聊好友和群组成员。

## Goals
- 支持在单聊和群组聊天中发起视频会议预约
- 实现视频会议的开始时间、结束时间设置（最长2小时限制）
- 在会议开始前10分钟允许参会者进入会议
- 提供会议管理员功能（关闭他人摄像头/麦克风、提前结束会议、开关聊天窗口）
- 提供参会者功能（开关自己的摄像头/麦克风、发送消息、查看所有参会者画面、退出会议、举手、全屏）
- 通过聊天卡片和"+"菜单提供会议入口

## Non-Goals (Out of Scope)
- ~~不支持会议录制功能~~ (已支持)
- ~~不支持会议回放功能~~ (已支持)
- ~~不支持屏幕共享~~ (已支持)
- 不支持 breakout rooms（分组讨论室）
- 不支持虚拟背景和美颜功能
- 不支持会议密码保护（依赖现有聊天权限体系）
- 不支持外部用户通过链接加入（仅限聊天参与者）
- 不支持会议日程与外部日历同步

## Background & Context
- 基于现有的 Flask + Socket.IO + SQLite 技术栈
- 已具备用户认证、私聊、群聊、文件传输等基础功能
- 使用 Bootstrap 5 作为前端 UI 框架
- 需要集成 WebRTC 技术实现音视频通信
- 现有的 talkroom.html 已包含基础的音频通话示例代码

## Functional Requirements

### FR-1: 会议预约与创建
- **FR-1.1**: 在聊天界面（单聊/群聊）右上角显示"+"按钮
- **FR-1.2**: 点击"+"按钮展开菜单，包含"视频会议"选项
- **FR-1.3**: 选择"视频会议"后弹出预约表单，包含：
  - 会议标题（可选，默认使用聊天对象名称）
  - 开始时间（日期时间选择器）
  - 结束时间（日期时间选择器，自动限制最大2小时）
  - 参会者列表（自动包含当前聊天对象/群组成员）
- **FR-1.4**: 提交后创建会议，在聊天中显示会议卡片

### FR-2: 会议入口与加入
- **FR-2.1**: 在聊天中显示会议卡片，包含：
  - 会议标题、时间信息
  - 会议状态（待开始/进行中/已结束）
  - 加入按钮（会议开始前10分钟启用）
- **FR-2.2**: 通过"+"菜单的"视频会议"选项查看所有可加入的会议
- **FR-2.3**: 点击加入后进入视频会议界面

### FR-3: 会议界面 - 视频网格
- **FR-3.1**: 主界面以网格形式显示所有参会者的视频画面
- **FR-3.2**: 每个视频画面显示用户名和状态图标（麦克风、摄像头）
- **FR-3.3**: 支持全屏模式切换
- **FR-3.4**: 自适应布局，根据参会人数调整网格排列

### FR-4: 会议界面 - 控制栏
- **FR-4.1**: 底部控制栏包含功能按钮：
  - 麦克风开关
  - 摄像头开关
  - 屏幕共享
  - 录制开关（仅管理员）
  - 举手
  - 聊天窗口开关
  - 全屏切换
  - 退出会议（红色按钮）

### FR-5: 会议聊天功能
- **FR-5.1**: 侧边栏或浮动窗口显示会议聊天
- **FR-5.2**: 支持发送文本消息
- **FR-5.3**: 显示系统消息（用户加入/离开、举手等）
- **FR-5.4**: 会议聊天消息保存30天
- **FR-5.5**: 可在"+"菜单的"所有视频会议"中查看历史会议聊天记录

### FR-6: 管理员功能
- **FR-6.1**: 会议创建者自动成为管理员
- **FR-6.2**: 管理员可以关闭指定参会者的摄像头
- **FR-6.3**: 管理员可以关闭指定参会者的麦克风
- **FR-6.4**: 管理员可以提前结束会议
- **FR-6.5**: 管理员可以打开/关闭会议聊天窗口（对全员生效）
- **FR-6.6**: 管理员可以开始/停止会议录制
- **FR-6.7**: 管理员拥有所有普通参会者的权限

### FR-7: 屏幕共享功能
- **FR-7.1**: 参会者可以点击屏幕共享按钮分享屏幕
- **FR-7.2**: 屏幕共享视频在网格中突出显示
- **FR-7.3**: 参会者可以随时停止屏幕共享
- **FR-7.4**: 同一时间只有一人可以共享屏幕（可选：管理员可强制停止他人共享）

### FR-8: 会议录制与回放功能
- **FR-8.1**: 管理员可以开始/停止会议录制
- **FR-8.2**: 录制内容包括音视频、屏幕共享
- **FR-8.3**: 录制文件保存到服务器
- **FR-8.4**: 在"+"菜单的"所有视频会议"中可查看历史会议列表
- **FR-8.5**: 历史会议可查看回放（如有录制）
- **FR-8.6**: 历史会议可查看聊天记录（保存30天）

### FR-9: 移动端UI适配
- **FR-9.1**: 移动端采用专门的竖屏布局
- **FR-9.2**: 视频网格在移动端优化为可滑动查看
- **FR-9.3**: 控制栏在移动端简化并适配触摸操作
- **FR-9.4**: 聊天窗口在移动端采用底部弹出式设计
- **FR-9.5**: 参会者列表在移动端采用抽屉式设计

### FR-10: 参会者功能
- **FR-10.1**: 参会者可以开关自己的摄像头
- **FR-10.2**: 参会者可以开关自己的麦克风
- **FR-10.3**: 参会者可以在会议聊天中发送消息
- **FR-10.4**: 参会者可以看到/听到其他参会者（如果未被静音）
- **FR-10.5**: 参会者可以举手（举手状态在界面中显示）
- **FR-10.6**: 参会者可以退出会议
- **FR-10.7**: 参会者可以切换到全屏模式
- **FR-10.8**: 参会者可以进行屏幕共享

### FR-11: 会议状态管理
- **FR-11.1**: 会议状态包括：scheduled（已预约）、active（进行中）、ended（已结束）、recording（录制中）
- **FR-11.2**: 到达开始时间自动切换到 active 状态
- **FR-11.3**: 到达结束时间或管理员结束自动切换到 ended 状态
- **FR-11.4**: 已结束的会议显示在"+"菜单的"所有视频会议"中，可查看回放和聊天记录
- **FR-11.5**: 录制状态作为独立标识，与会议状态并行

## Non-Functional Requirements

### NFR-1: 性能要求
- **NFR-1.1**: 视频延迟不超过 500ms
- **NFR-1.2**: 支持最多 20 人同时参会
- **NFR-1.3**: 页面加载时间不超过 3 秒

### NFR-2: 兼容性要求
- **NFR-2.1**: 支持 Chrome、Firefox、Safari、Edge 最新两个版本
- **NFR-2.2**: 支持移动端浏览器（iOS Safari、Android Chrome）

### NFR-3: 安全性要求
- **NFR-3.1**: 只有聊天参与者可以加入对应会议
- **NFR-3.2**: WebRTC 连接使用加密传输

### NFR-4: 可用性要求
- **NFR-4.1**: 界面响应式，适配桌面和移动设备
- **NFR-4.2**: 提供清晰的错误提示（如权限被拒绝、设备不可用等）

## Constraints

### Technical
- 使用 WebRTC 进行音视频通信
- 使用 Socket.IO 进行信令传输
- 后端使用 Flask + SQLite
- 前端使用 Bootstrap 5 + Vanilla JavaScript
- 需要 HTTPS 环境（WebRTC 要求）

### Business
- 会议时长限制为最大 2 小时
- 参会人数限制为 20 人

### Dependencies
- 需要浏览器支持 WebRTC API
- 需要摄像头和麦克风权限

## Assumptions
- 用户设备具备摄像头和麦克风
- 网络环境支持 WebRTC 连接
- 用户已授予摄像头和麦克风权限
- 服务器支持 HTTPS（WebRTC 要求）

## Acceptance Criteria

### AC-1: 会议预约创建
- **Given**: 用户已登录并处于私聊或群聊界面
- **When**: 用户点击右上角"+"按钮并选择"视频会议"
- **Then**: 弹出会议预约表单，用户可设置开始/结束时间
- **Verification**: `human-judgment`
- **Notes**: 结束时间应自动限制在开始时间后2小时内

### AC-2: 会议卡片显示
- **Given**: 用户成功创建会议
- **When**: 会议信息保存到数据库
- **Then**: 在聊天界面显示会议卡片，包含会议信息和状态
- **Verification**: `programmatic`
- **Notes**: 检查数据库记录和前端渲染

### AC-3: 加入会议入口
- **Given**: 会议已创建且距离开始时间不足10分钟
- **When**: 参会者查看聊天界面或"+"菜单
- **Then**: "加入会议"按钮变为可用状态
- **Verification**: `programmatic`
- **Notes**: 验证时间计算逻辑和UI状态更新

### AC-4: 视频会议界面加载
- **Given**: 用户点击"加入会议"按钮
- **When**: 浏览器请求摄像头和麦克风权限
- **Then**: 成功加载视频会议界面，显示本地视频预览
- **Verification**: `human-judgment`
- **Notes**: 需要手动测试权限请求和界面加载

### AC-5: 音视频通信
- **Given**: 多名用户已加入同一会议
- **When**: 用户开启摄像头和麦克风
- **Then**: 所有参会者可以看到和听到该用户
- **Verification**: `human-judgment`
- **Notes**: 需要多人测试验证

### AC-6: 管理员控制权限
- **Given**: 用户是会议管理员
- **When**: 管理员点击其他参会者的"关闭摄像头"按钮
- **Then**: 该参会者的摄像头被关闭，视频画面显示为关闭状态
- **Verification**: `human-judgment`
- **Notes**: 验证管理员权限和控制功能

### AC-7: 参会者基础功能
- **Given**: 用户是普通参会者
- **When**: 用户点击麦克风/摄像头开关按钮
- **Then**: 对应设备状态切换，图标更新
- **Verification**: `programmatic`
- **Notes**: 验证状态变化和UI更新

### AC-8: 举手功能
- **Given**: 用户是参会者
- **When**: 用户点击"举手"按钮
- **Then**: 举手状态在界面中显示，其他参会者可见
- **Verification**: `human-judgment`
- **Notes**: 验证举手状态的同步显示

### AC-9: 会议聊天
- **Given**: 用户处于会议中
- **When**: 用户在会议聊天窗口发送消息
- **Then**: 所有参会者看到该消息
- **Verification**: `programmatic`
- **Notes**: 验证消息传输和显示

### AC-10: 提前结束会议
- **Given**: 用户是会议管理员
- **When**: 管理员点击"结束会议"按钮
- **Then**: 会议状态变为 ended，所有参会者被移出会议
- **Verification**: `programmatic`
- **Notes**: 验证会议状态更新和参与者通知

### AC-11: 会议超时自动结束
- **Given**: 会议正在进行中
- **When**: 到达预设的结束时间
- **Then**: 会议自动结束，状态变为 ended
- **Verification**: `programmatic`
- **Notes**: 验证定时任务或时间检查逻辑

### AC-12: 全屏功能
- **Given**: 用户处于会议中
- **When**: 用户点击全屏按钮
- **Then**: 会议界面切换到全屏模式
- **Verification**: `human-judgment`
- **Notes**: 验证全屏API调用和界面适配

## Open Questions
- [x] 是否需要支持屏幕共享功能？**是**
- [x] 是否需要支持会议录制？**是**
- [x] 移动端是否需要专门的UI适配？**是**
- [x] 是否需要支持虚拟背景？**否**
- [x] 会议聊天消息是否需要持久化存储？**是，保存30天**
